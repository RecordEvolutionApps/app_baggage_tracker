services:
    mediasoup:
        build: ./mediasoup
        init: true
        stop_grace_period: 2s
        ports:
            - 1200:1200
            - 2000-2100:2000-2100/udp   # WebRTC media (ICE/DTLS/SRTP)
            - 2000-2100:2000-2100/tcp   # WebRTC TCP fallback
        environment:
            # ANNOUNCED_IP must be the public/reachable IP of the Jetson so that
            # ICE candidates sent to browsers (via TURN) point to this host.
            # Override at deploy time:  ANNOUNCED_IP=<public-ip> docker compose up
            - ANNOUNCED_IP=${ANNOUNCED_IP:-192.168.0.19}
            - RTP_PORT_MIN=2000
            - RTP_PORT_MAX=2100
        # entrypoint: "sleep infinity"
    video:
        build:
            context: ./video
            dockerfile: Dockerfile
        volumes:
            - data:/data
        depends_on:
            - mediasoup
        network_mode: service:mediasoup
        privileged: true  # **WARNING: Security Risk**
        devices:
            - /dev/bus/usb:/dev/bus/usb
            - /dev/nvidia*:/dev/nvidia*
        runtime: nvidia
        environment:
            - MEDIASOUP_URL=http://127.0.0.1:1200
        # entrypoint: "sleep infinity"
    web:
        build: ./web
        ports:
            - 1100:1100
        volumes:
            - data:/data
        depends_on: 
            - video
        environment:
            - VIDEO_API=http://mediasoup:8000
        # entrypoint: "sleep infinity"
volumes:
    data:
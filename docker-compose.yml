services:
    mediasoup:
        build: ./mediasoup
        restart: unless-stopped
        init: true
        stop_grace_period: 2s
        ports:
            - 1200:1200
            - 10000-10100:10000-10100/udp   # WebRTC media (ICE/DTLS/SRTP)
            - 10000-10100:10000-10100/tcp   # WebRTC TCP fallback
        environment:
            # ANNOUNCED_IP must be the public/reachable IP of the Jetson so that
            # ICE candidates sent to browsers (via TURN) point to this host.
            # Override at deploy time:  ANNOUNCED_IP=<public-ip> docker compose up
            # ANNOUNCED_IP_FALLBACK adds a second ICE candidate as a fallback
            # (e.g. LAN IP when the primary is a reverse-proxy URL).
            - ANNOUNCED_IP=${DEVICE_KEY}-baggagetracker-1100.app.ironflock.com
            - ANNOUNCED_IP_FALLBACK=192.168.0.19
            - RTP_PORT_MIN=10000
            - RTP_PORT_MAX=10100
        # entrypoint: "sleep infinity"
    video:
        build:
            context: ./video
            dockerfile: Dockerfile
        restart: unless-stopped
        volumes:
            - data:/data
        depends_on:
            - mediasoup
        network_mode: service:mediasoup
        privileged: true  # **WARNING: Security Risk**
        devices:
            - /dev/bus/usb:/dev/bus/usb    # USB cameras (UVC)
            # MIPI CSI / GMSL cameras are available via privileged mode
            # (they appear as /dev/video* through the Jetson ISP / deserializer drivers)
        # Note: no "runtime: nvidia" here â€” on Jetson the Docker daemon is
        # configured with nvidia as the default runtime via daemon.json.
        environment:
            - MEDIASOUP_URL=http://127.0.0.1:1200
        # entrypoint: "sleep infinity"
    web:
        build: ./web
        restart: unless-stopped
        ports:
            - 1100:1100
        volumes:
            - data:/data
        depends_on: 
            - video
        environment:
            - VIDEO_API=http://mediasoup:8000
        # entrypoint: "sleep infinity"
volumes:
    data: